# ====================================================
# Workflow: update.yml
# Repo:     my-movie-database
# Author:   BruceBanner001
# ====================================================
#
# This GitHub Actions workflow:
# - Runs weekly (Monday 09:00 UTC) OR manually via Actions tab
# - Installs Python + dependencies (requirements.txt)
# - Writes Google Drive service account credentials from secret
# - Runs create_update_backup_delete.py:
#     ‚Ä¢ Reads Excel from Drive (private)
#     ‚Ä¢ Generates seriesData.json
#     ‚Ä¢ Downloads & resizes cover images (600x900, absolute URLs)
#     ‚Ä¢ Scrapes high-quality synopsis & duration
#     ‚Ä¢ Creates backups of changed/removed objects
# - Commits and pushes updated seriesData.json, images/, and backups/
# - Publishes via GitHub Pages
#
# ====================================================


name: Weekly Excel -> JSON Update

on:
  schedule:
    - cron: "30 18 * * 0"  # Every Sunday 12:00 AM IST (18:30 UTC Saturday)
  workflow_dispatch:

jobs:
  update-json:
    runs-on: ubuntu-latest

    steps:
      # Checkout repo
      - name: Checkout repo
        uses: actions/checkout@v4

      # Set up Python
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # Install dependencies
      - name: Install dependencies
        run: pip install -r requirements.txt

      # ‚úÖ Write Google Drive service account credentials
      - name: Write Google Drive credentials
        run: echo '${{ secrets.GDRIVE_SERVICE_ACCOUNT }}' > GDRIVE_SERVICE_ACCOUNT.json

      # Run update script
      - name: Run update script
        run: python create_update_backup_delete.py

      # Commit and push changes
      - name: Commit and push changes
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add seriesData.json images/ backups/
          git commit -m "Auto-update JSON and images"
          git push

      # Deploy to GitHub Pages
      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: .  # publish root directory (JSON + images)

      # ‚úÖ Success email
      - name: Send success email
        if: success()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: "‚úÖ Weekly Excel ‚Üí JSON Update Succeeded!"
          to: "subramanianthayuman@gmail.com"
          from: "GitHub Actions <subramanianthayuman@gmail.com>"
          body: "The workflow succeeded and your JSON, images, and backups were updated + published."

      # ‚ùå Failure email
      - name: Send failure email
        if: failure()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: "üö® Weekly Excel ‚Üí JSON Update FAILED!"
          to: "subramanianthayuman@gmail.com"
          from: "GitHub Actions <subramanianthayuman@gmail.com>"
          body: "The workflow failed while updating your drama collection. Please check logs in GitHub Actions."
