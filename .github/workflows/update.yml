# ============================================================================
# Workflow: Excel → JSON Automation
# Purpose : Automate scheduled and manual Excel-to-JSON updates.
# Version : 4.3 (Final: Cleans up secrets and handles App Passwords)
# ============================================================================

name: Excel → JSON Update

on:
  workflow_dispatch:
  schedule:
    - cron: "30 18 * * 6"

jobs:
  update-json:
    timeout-minutes: 50
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: 1. Checkout repository
        uses: actions/checkout@v4

      - name: 2. Set up Python environment
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: 3. Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: 4. Configure Secrets
        env:
          EXCEL_FILE_ID: ${{ secrets.EXCEL_FILE_ID }}
          GDRIVE_SERVICE_ACCOUNT: ${{ secrets.GDRIVE_SERVICE_ACCOUNT }}
        run: |
          printf '%s' "$EXCEL_FILE_ID" > EXCEL_FILE_ID.txt
          printf '%s' "$GDRIVE_SERVICE_ACCOUNT" > GDRIVE_SERVICE_ACCOUNT.json

      - name: 5. Run the Excel-to-JSON update script
        id: run_updater
        env:
          SHEETS: "Sheet1"
          GITHUB_PAGES_URL: "https://brucebanner001.github.io/my-movie-database"
        run: |
          python create_update_backup_delete.py

      # [ THE PUSH PROTECTION FIX IS HERE ]
      - name: 6. Cleanup Secret Files
        # This step runs whether the script succeeded or failed, ensuring secrets are never committed.
        if: always()
        run: |
          echo "Removing temporary secret files..."
          rm -f EXCEL_FILE_ID.txt GDRIVE_SERVICE_ACCOUNT.json
      
      - name: 7. Commit and Push Changes
        if: success()
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add -A --force
          if git diff --cached --quiet; then
            echo "No data changes to commit."
          else
            git commit -m "Automated data update: $(date -u '+%Y-%m-%d %H:%M UTC')"
            git push
          fi
      
      - name: 8. Find Report File Path (on success)
        id: find_report
        if: success()
        run: |
          report_path=$(find reports -type f -name "Report_*.txt" | sort -r | head -n1)
          echo "report_path=$report_path" >> "$GITHUB_OUTPUT"
          
      - name: 9. Send Success Email
        if: success()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ secrets.SMTP_SERVER }}
          server_port: ${{ secrets.SMTP_PORT }}
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }} # Use your new App Password here
          subject: '[Manual] Workflow - Final Report'
          body: 'Workflow completed successfully. See attached report.'
          to: ${{ secrets.NOTIFY_EMAIL }}
          from: ${{ secrets.SMTP_USERNAME }}
          files: ${{ steps.find_report.outputs.report_path }}

      - name: 10. Send Failure Email
        if: failure()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ secrets.SMTP_SERVER }}
          server_port: ${{ secrets.SMTP_PORT }}
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }} # Use your new App Password here
          subject: '[ACTION REQUIRED] Workflow FAILED'
          body: 'The workflow failed. Please check the Actions log on GitHub for details.'
          to: ${{ secrets.NOTIFY_EMAIL }}
          from: ${{ secrets.SMTP_USERNAME }}