# ============================================================================
# Workflow: Excel → JSON Automation
# Purpose : Automate weekly + manual Excel → JSON updates, deletions, backups,
#           and run reports (TXT only) for "my-movie-database".
# ============================================================================

name: Excel → JSON Update

on:
  workflow_dispatch:
    inputs:
      MAX_RUN_TIME_MINUTES:
        description: 'Max run time in minutes for this run (0 = no time limit)'
        default: '300'
        required: false
      MAX_PER_RUN:
        description: 'Limit number of shows to process (0 = process all)'
        default: '0'
        required: false
  schedule:
    - cron: "30 18 * * 6"  # Every Sunday 00:00 AM IST (Saturday 18:30 UTC)

jobs:
  update-json:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      # ------------------------------------------------------
      # 1. Checkout repo
      # ------------------------------------------------------
      - name: Checkout repo
        uses: actions/checkout@v4

      # ------------------------------------------------------
      # 2. Set up Python
      # ------------------------------------------------------
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # ------------------------------------------------------
      # 3. Install dependencies
      # ------------------------------------------------------
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # ------------------------------------------------------
      # 4. Ensure required folders exist
      # ------------------------------------------------------
      - name: Ensure required folders exist
        run: |
          mkdir -p backups deleted-data reports images

      # ------------------------------------------------------
      # 5. Write secrets to files
      # ------------------------------------------------------
      - name: Write Excel file ID
        run: echo "${{ secrets.EXCEL_FILE_ID }}" > EXCEL_FILE_ID.txt

      - name: Write Google Drive service account
        run: echo '${{ secrets.GDRIVE_SERVICE_ACCOUNT }}' > GDRIVE_SERVICE_ACCOUNT.json

      # ------------------------------------------------------
      # 6. Run main script (Excel → JSON)
      # ------------------------------------------------------
      - name: Run Excel → JSON script
        id: run_updater
        env:
          GITHUB_PAGES_URL: https://brucebanner001.github.io/my-movie-database
          MAX_PER_RUN: ${{ github.event.inputs.MAX_PER_RUN || 0 }}
          MAX_RUN_TIME_MINUTES: ${{ github.event.inputs.MAX_RUN_TIME_MINUTES || 300 }}
          KEEP_OLD_IMAGES_DAYS: 7
          SCHEDULED_RUN: ${{ github.event_name == 'schedule' && 'true' || 'false' }}
        run: |
          set -e
          python create_update_backup_delete.py | tee updater_output.txt

          # Extract email body if present
          awk '/^===EMAIL_BODY_START===$/{flag=1;next}/^===EMAIL_BODY_END===$/{flag=0}flag' updater_output.txt > email_body.html || true

          if [ -s email_body.html ]; then
            encoded_body=$(base64 -w 0 email_body.html)
            subj_date=$(date -u "+%d %B %Y %H%M")
            echo "email_subject=[${{ github.event_name == 'schedule' && 'Automatic' || 'Manual' }}] Workflow $subj_date Report" >> $GITHUB_OUTPUT
            echo "email_body=$encoded_body" >> $GITHUB_OUTPUT
          fi

      # ------------------------------------------------------
      # 6.1 Cleanup old backups & deleted-data
      # ------------------------------------------------------
      - name: Cleanup old backups and deleted-data
        run: |
          find backups/ -type f -mtime +${{ env.KEEP_OLD_IMAGES_DAYS }} -exec rm -f {} \;
          find deleted-data/ -type f -mtime +${{ env.KEEP_OLD_IMAGES_DAYS }} -exec rm -f {} \;

      # ------------------------------------------------------
      # 7. Commit and push changes
      # ------------------------------------------------------
      - name: Commit & push changes
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add seriesData.json images/ backups/ reports/ deleted-data/
          git commit -m "Automated update: $(date -u '+%Y-%m-%d %H:%M:%S')" || echo "No changes to commit"
          git push

      # ------------------------------------------------------
      # 8. Upload report TXT files
      # ------------------------------------------------------
      - name: Upload report TXT files
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: reports
          path: reports/*.txt

      # ------------------------------------------------------
      # 9. Upload backups folder separately
      # ------------------------------------------------------
      - name: Upload backups folder
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: backups
          path: backups/

      # ------------------------------------------------------
      # 10. Upload deleted-data folder separately
      # ------------------------------------------------------
      - name: Upload deleted-data folder
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: deleted-data
          path: deleted-data/

      # ------------------------------------------------------
      # 11. Scan for secrets
      # ------------------------------------------------------
      - name: Scan for secrets
        if: always()
        uses: gitleaks/gitleaks-action@v2
        with:
          args: detect --source=. --report-path=reports/secrets_report.txt --no-banner --redact

      # ------------------------------------------------------
      # 12. Send consolidated HTML report email
      # ------------------------------------------------------
      - name: Send consolidated report email
        if: steps.run_updater.outputs.email_body != ''
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ secrets.SMTP_SERVER }}
          server_port: ${{ secrets.SMTP_PORT }}
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: ${{ steps.run_updater.outputs.email_subject }}
          body: ${{ steps.run_updater.outputs.email_body }}
          is_base64: true
          content_type: text/html
          to: ${{ secrets.NOTIFY_EMAIL }}
          from: GitHub Actions <${{ secrets.SMTP_USERNAME }}>
