# ====================================================
# Workflow: update.yml
# Repo:     my-movie-database
# Author:   BruceBanner001
# ====================================================
#
# This GitHub Actions workflow:
# - Runs weekly (Sunday 12:00 AM IST) OR manually via Actions tab
# - Installs Python + dependencies (requirements.txt)
# - Writes Google Drive service account credentials from secret
# - Runs create_update_backup_delete.py:
#     ‚Ä¢ Reads Excel from Drive (private)
#     ‚Ä¢ Generates seriesData.json
#     ‚Ä¢ Downloads & resizes cover images (600x900, absolute URLs)
#     ‚Ä¢ Scrapes high-quality synopsis & duration
#     ‚Ä¢ Creates backups of changed/removed objects
# - Commits and pushes updated seriesData.json, images/, and backups/
# - Publishes via GitHub Pages
#
# ====================================================
name: Weekly Excel -> JSON Update

on:
  schedule:
    - cron: "30 18 * * 0"  # Every Sunday 12:00 AM IST (18:30 UTC Saturday)
  workflow_dispatch:

permissions:
  contents: write   # allow pushing JSON/images/backups
  pages: write      # allow GitHub Pages deployment
  id-token: write   # required for deploy-pages

jobs:
  update-json:
    runs-on: ubuntu-latest
    steps:
      # Checkout repo
      - name: Checkout repo
        uses: actions/checkout@v4

      # Set up Python
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # Install dependencies
      - name: Install dependencies
        run: pip install -r requirements.txt

      # Write Google Drive credentials
      - name: Write Google Drive credentials
        run: echo '${{ secrets.GDRIVE_SERVICE_ACCOUNT }}' > GDRIVE_SERVICE_ACCOUNT.json

      # Write Excel File ID
      - name: Write Excel File ID
        run: echo "${{ secrets.EXCEL_FILE_ID }}" > EXCEL_FILE_ID.txt

      # Run update script
      - name: Run update script
        run: python create_update_backup_delete.py

      # Commit and push changes
      - name: Commit and push changes
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add seriesData.json || true
          if [ -d "images" ]; then git add images/; fi
          if [ -d "backups" ]; then git add backups/; fi
          git commit -m "Auto-update JSON and images" || echo "No changes to commit"
          git push https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git HEAD:master

      # Upload artifact for Pages
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: .

  deploy:
    needs: update-json
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      # ‚úÖ Success email
      - name: Send success email
        if: success()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: "‚úÖ Weekly Excel ‚Üí JSON Update Succeeded!"
          to: "subramanianthayuman@gmail.com"
          from: "GitHub Actions <subramanianthayuman@gmail.com>"
          body: "The workflow succeeded and your JSON, images, and backups were updated + published."

      # ‚ùå Failure email
      - name: Send failure email
        if: failure()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: "üö® Weekly Excel ‚Üí JSON Update FAILED!"
          to: "subramanianthayuman@gmail.com"
          from: "GitHub Actions <subramanianthayuman@gmail.com>"
          body: "The workflow failed while updating your drama collection. Please check logs in GitHub Actions."
