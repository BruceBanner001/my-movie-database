# ============================================================================
# Workflow: Excel â†’ JSON Automation
# Purpose : Automate weekly + manual Excel â†’ JSON updates, deletions, backups,
#           and run reports (TXT only) for "my-movie-database".
# ============================================================================
name: Excel â†’ JSON Automation

on:
  workflow_dispatch:
    inputs:
      MAX_RUN_MINUTES:
        description: 'Max run time in minutes for this run (0 = no time limit)'
        required: false
        default: '180'
  schedule:
    - cron: '0 12 * * 0'   # Sunday 12:00 UTC

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  update:
    runs-on: ubuntu-latest
    env:
      MAX_PER_RUN: 0
      KEEP_OLD_IMAGES_DAYS: 7
      GITHUB_PAGES_URL: "https://<your-username>.github.io/my-movie-database"
      TZ: "Asia/Kolkata"

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: python -m pip install --upgrade pip && pip install -r requirements.txt

      - name: Write GDrive service account (if provided)
        run: |
          if [ -n "${{ secrets.GDRIVE_SERVICE_ACCOUNT }}" ]; then
            echo "${{ secrets.GDRIVE_SERVICE_ACCOUNT }}" > GDRIVE_SERVICE_ACCOUNT.json
          fi

      - name: Write Excel File ID (if provided)
        run: |
          if [ -n "${{ secrets.EXCEL_FILE_ID }}" ]; then
            echo "${{ secrets.EXCEL_FILE_ID }}" > EXCEL_FILE_ID.txt
          fi

      - name: Set MAX_RUN_TIME_MINUTES
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "MAX_RUN_TIME_MINUTES=${{ github.event.inputs.MAX_RUN_MINUTES }}" >> $GITHUB_ENV
          else
            echo "MAX_RUN_TIME_MINUTES=240" >> $GITHUB_ENV
          fi

      - name: Run update script
        run: |
          if [[ "${{ github.event_name }}" == "schedule" ]]; then
            export SCHEDULED_RUN=true
          else
            export SCHEDULED_RUN=false
          fi
          python create_update_backup_delete.py

      - name: Upload TXT reports
        uses: actions/upload-artifact@v4
        with:
          name: reports
          path: reports/*.txt

      - name: Check for secret exposure
        run: |
          mkdir -p reports
          exposed=false
          if [ -n "${{ secrets.EXCEL_FILE_ID }}" ] && grep -R -F "${{ secrets.EXCEL_FILE_ID }}" .; then
            exposed=true
          fi
          if [ -n "${{ secrets.GDRIVE_SERVICE_ACCOUNT }}" ] && grep -R -F "${{ secrets.GDRIVE_SERVICE_ACCOUNT }}" .; then
            exposed=true
          fi
          echo "SecretsExposed:${exposed}" > reports/secrets_status.txt

      - name: Commit & Push changes
        if: success()
        run: |
          git config user.name github-actions
          git config user.email github-actions@github.com
          git add seriesData.json reports/ images/ backups/ deleted-data/ || true
          git commit -m "Auto update: $(date -u +'%Y-%m-%d %H:%M:%S')" || echo "No changes to commit"
          git push || echo "git push failed"

      - name: Send success email
        if: success()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: "âœ… Excel â†’ JSON Update SUCCESS"
          to: ${{ secrets.NOTIFY_EMAIL }}
          from: "GitHub Actions <${{ secrets.NOTIFY_EMAIL }}>"
          body: |
            $(cat reports/secrets_status.txt)

            Run type: ${{ github.event_name }}
            Outcome: SUCCESS
            Run timestamp: $(date -u)

            See attached run report.
          attachments: reports/*.txt

      - name: Send failure email
        if: failure()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: "ðŸš¨ Excel â†’ JSON Update FAILED!"
          to: ${{ secrets.NOTIFY_EMAIL }}
          from: "GitHub Actions <${{ secrets.NOTIFY_EMAIL }}>"
          body: |
            $(cat reports/secrets_status.txt)

            Run type: ${{ github.event_name }}
            Outcome: FAILURE
            Run timestamp: $(date -u)

            See attached run report.
          attachments: reports/*.txt

      - name: Clean up
        run: rm -f EXCEL_FILE_ID.txt GDRIVE_SERVICE_ACCOUNT.json
