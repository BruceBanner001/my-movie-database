# ============================================================================
# Workflow: Excel → JSON Automation
# Purpose : Automate weekly + manual Excel → JSON updates, deletions, backups,
#           and run reports for "my-movie-database".
# Version : 2.0 (Robust & Cleaned)
# ============================================================================

name: Excel → JSON Update

on:
  workflow_dispatch:
    inputs:
      MAX_RUN_TIME_MINUTES:
        description: 'Max run time in minutes (0 = no limit, GitHub max is ~350)'
        default: '50' # Keep it safely below the GitHub limit
        required: false
      MAX_PER_RUN:
        description: 'Limit number of shows to process per run (0 = process all)'
        default: '0'
        required: false
  schedule:
    - cron: "30 18 * * 6"  # Every Sunday 00:00 AM IST (Saturday 18:30 UTC)

jobs:
  update-json:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          # FIX: Removed '|| true'. If dependencies fail, the workflow MUST fail.
          # This requires a 'requirements.txt' file in your repository.
          pip install -r requirements.txt

      - name: Write Excel file ID from Secret
        env:
          EXCEL_FILE_ID: ${{ secrets.EXCEL_FILE_ID }}
        run: |
          set -euo pipefail
          printf '%s' "$EXCEL_FILE_ID" > EXCEL_FILE_ID.txt

      - name: Write Google Drive Service Account from Secret
        env:
          GDRIVE_SERVICE_ACCOUNT: ${{ secrets.GDRIVE_SERVICE_ACCOUNT }}
        run: |
          set -euo pipefail
          printf '%s' "$GDRIVE_SERVICE_ACCOUNT" > GDRIVE_SERVICE_ACCOUNT.json

      # ------------------ Run updater and capture report ------------------
      - name: Run Excel→JSON updater
        id: run_updater
        env:
          # Use github.event.inputs for manual runs, and provide a default for scheduled runs
          MAX_RUN_TIME_MINUTES: ${{ github.event.inputs.MAX_RUN_TIME_MINUTES || '50' }}
          MAX_PER_RUN: ${{ github.event.inputs.MAX_PER_RUN || '0' }}
          SCHEDULED_RUN: ${{ github.event_name == 'schedule' }}
        run: |
          set -euo pipefail
          
          # FIX: Removed '|| true'. If the Python script fails, this step will fail,
          # which correctly stops the workflow and alerts you to the error.
          output=$(python create_update_backup_delete.py 2>&1)
          printf '%s\n' "$output"

          # IMPROVEMENT: Simplified and more robust way to find the report path from the script's output.
          report_path=$(echo "$output" | grep -oP 'Final report written -> \K.*' || true)
          if [ -z "$report_path" ]; then
            # Fallback if the primary method fails for any reason
            report_path=$(ls -t reports/Report_*.txt 2>/dev/null | head -n1 || true)
          fi
          echo "report_path=$report_path" >> "$GITHUB_OUTPUT"

          # Email subject logic remains the same, it's solid.
          if [ "${{ env.SCHEDULED_RUN }}" = "true" ]; then
            prefix="[Automatic]"
          else
            prefix="[Manual]"
          fi
          subj_date=$(date -u -d '+5 hours 30 minutes' "+%d %B %Y %H:%M")
          echo "email_subject=$prefix Workflow $subj_date IST Report" >> "$GITHUB_OUTPUT"

      # ------------------ Commit & push all changes ------------------
      - name: Commit & push all changes
        run: |
          set -euo pipefail
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          # IMPROVEMENT: Combine all generated files into a single, atomic commit for a clean history.
          git add seriesData.json images/ backups/ reports/ deleted-data/ deleted-images/ backup-meta-data/ .gitignore || true
          
          if git diff --cached --quiet; then
            echo "No data changes to commit."
          else
            # IMPROVEMENT: More descriptive commit message.
            commit_message="Automated data update: $(date -u '+%Y-%m-%d %H:%M UTC')"
            echo "Creating commit: $commit_message"
            git commit -m "$commit_message"
            git push
          fi

      # ------------------ Upload Reports as Artifact ------------------
      - name: Upload reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: run-reports
          path: reports/

      # ------------------ Compose Consolidated Email Body ------------------
      - name: Compose consolidated email body
        id: compose_email
        if: always()
        env:
          REPORT_PATH: ${{ steps.run_updater.outputs.report_path }}
        run: |
          set -euo pipefail
          report_file="${REPORT_PATH:-}"
          # Final fallback check for the report file
          if [ -z "$report_file" ] || [ ! -f "$report_file" ]; then
            report_file=$(ls -t reports/Report_*.txt 2>/dev/null | head -n1 || true)
          fi
          
          # Create a temporary file to hold the full email body
          email_body_file=$(mktemp)
          {
            if [ -f "$report_file" ]; then
              cat "$report_file"
            else
              echo "⚠️ CRITICAL: The main report file could not be found."
              echo "Please check the workflow logs for errors."
            fi
            
            # Optionally add Gitleaks secret scan results if you use it
            if [ -s "reports/secrets_report.txt" ]; then
              echo ""
              echo "--- SECRETS CHECK ---"
              echo "Gitleaks detected potential secrets:"
              cat reports/secrets_report.txt
            fi
          } > "$email_body_file"
          echo "body_file=$email_body_file" >> "$GITHUB_OUTPUT"

      # ------------------ Send Consolidated Report Email ------------------
      - name: Send consolidated report email
        if: always()
        # IMPROVEMENT: Using a dedicated, reliable action for sending email.
        # This is much cleaner and more maintainable than the previous base64 script.
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ secrets.SMTP_SERVER }}
          server_port: ${{ secrets.SMTP_PORT }}
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: ${{ steps.run_updater.outputs.email_subject }}
          body: file://${{ steps.compose_email.outputs.body_file }}
          to: ${{ secrets.NOTIFY_EMAIL }}
          from: ${{ secrets.SMTP_USERNAME }}
          
      # ------------------ Cleanup Temporary Files ------------------
      - name: Cleanup Temp Email File
        if: always()
        run: |
          rm -f ${{ steps.compose_email.outputs.body_file }} || true