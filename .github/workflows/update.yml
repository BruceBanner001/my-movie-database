# ============================================================================
# Workflow: Excel → JSON Automation
# Purpose : Automate scheduled and manual Excel-to-JSON updates.
# Version : 4.6 (Final: Added DEBUG_FETCH flag for diagnostics)
# ============================================================================

name: Excel → JSON Update

on:
  workflow_dispatch:
  schedule:
    - cron: "30 18 * * 6"

jobs:
  update-json:
    timeout-minutes: 50
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: 1. Checkout repository
        uses: actions/checkout@v4

      - name: 2. Set up Python environment
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: 3. Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: 4. Configure Secrets
        env:
          EXCEL_FILE_ID: ${{ secrets.EXCEL_FILE_ID }}
          GDRIVE_SERVICE_ACCOUNT: ${{ secrets.GDRIVE_SERVICE_ACCOUNT }}
        run: |
          printf '%s' "$EXCEL_FILE_ID" > EXCEL_FILE_ID.txt
          printf '%s' "$GDRIVE_SERVICE_ACCOUNT" > GDRIVE_SERVICE_ACCOUNT.json

      - name: 5. Run the Excel-to-JSON update script
        id: run_updater
        env:
          SHEETS: "Sheet1;Sheet2"
          GITHUB_PAGES_URL: "https://brucebanner001.github.io/my-movie-database"
          
          # [ THE MOST IMPORTANT DEBUGGING TOOL IS HERE ]
          # To see exactly why fetching is failing, set this to "true"
          # The workflow log will show a step-by-step of the scraping process.
          DEBUG_FETCH: "true"
          
        run: |
          python create_update_backup_delete.py 2>&1 | tee output.log
          script_exit_code=${PIPESTATUS[0]}
          output=$(cat output.log)
          echo "output_log<<EOF" >> "$GITHUB_OUTPUT"; echo "$output" >> "$GITHUB_OUTPUT"; echo "EOF" >> "$GITHUB_OUTPUT"
          report_path=$(echo "$output" | grep -oP 'Report written -> \K.*')
          echo "report_path=$report_path" >> "$GITHUB_OUTPUT"
          exit $script_exit_code

      - name: 6. Cleanup Secret Files
        if: always()
        run: |
          rm -f EXCEL_FILE_ID.txt GDRIVE_SERVICE_ACCOUNT.json

      - name: 7. Commit and Push Changes
        if: success()
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add -A --force
          if git diff --cached --quiet; then
            echo "No data changes to commit."
          else
            git commit -m "Automated data update: $(date -u '+%Y-%m-%d %H:%M UTC')"
            git push
          fi
      
      - name: 8. Compose Email Body
        id: compose_email
        if: always()
        env:
          WORKFLOW_STATUS: ${{ job.status }}
          SCRIPT_OUTPUT: ${{ steps.run_updater.outputs.output_log }}
        run: |
          email_body_file=$(mktemp)
          echo "body_file=$email_body_file" >> "$GITHUB_OUTPUT"
          report_file=$(find reports -type f -name "Report_*.txt" | sort -r | head -n1 || true)
          {
            if [[ "${WORKFLOW_STATUS}" == "success" ]]; then
              echo "✅ Workflow completed successfully."
              echo ""
              if [[ -f "$report_file" ]]; then cat "$report_file"; else echo "⚠️ Report file was not found."; fi
            else
              echo "❌ Workflow FAILED."
              echo "Please check the Actions log on GitHub. Raw script output is below:"
              echo "===================================================================="
              echo "$SCRIPT_OUTPUT"
            fi
          } > "$email_body_file"
          
      - name: 9. Send Final Email Notification
        if: always()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ secrets.SMTP_SERVER }}
          server_port: ${{ secrets.SMTP_PORT }}
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: >
            ${{ job.status == 'success' && '[Manual] Workflow - Final Report' || '[ACTION REQUIRED] Workflow FAILED' }}
          body: file://${{ steps.compose_email.outputs.body_file }}
          to: ${{ secrets.NOTIFY_EMAIL }}
          from: ${{ secrets.SMTP_USERNAME }}